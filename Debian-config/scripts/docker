#!/bin/bash

# Docker Installation Script for Debian/Ubuntu with Nala
# Includes NVIDIA Container Toolkit for GPU support

set -e  # Exit on any error

echo "Starting Docker installation..."

# Update package index
sudo nala update

# Remove any conflicting packages
echo "Removing conflicting packages..."
for pkg in docker.io docker-doc docker-compose podman-docker containerd runc; do 
    sudo nala remove $pkg -y 2>/dev/null || true
done

echo "Installing prerequisites..."
sudo nala install -y ca-certificates curl gnupg

sudo install -m 0755 -d /etc/apt/keyrings

echo "Adding Docker GPG key..."
sudo curl -fsSL https://download.docker.com/linux/debian/gpg -o /etc/apt/keyrings/docker.asc
sudo chmod a+r /etc/apt/keyrings/docker.asc

echo "Adding Docker repository..."
echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/debian \
  $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | \
  sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

sudo nala update

echo "Installing Docker packages..."
sudo nala install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

echo "Installing NVIDIA Container Toolkit..."
curl -fsSL https://nvidia.github.io/libnvidia-container/gpgkey | sudo gpg --dearmor -o /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg

curl -s -L https://nvidia.github.io/libnvidia-container/stable/deb/nvidia-container-toolkit.list | \
    sed 's#deb https://#deb [signed-by=/usr/share/keyrings/nvidia-container-toolkit-keyring.gpg] https://#g' | \
    sudo tee /etc/apt/sources.list.d/nvidia-container-toolkit.list

sudo nala update
sudo nala install -y nvidia-container-toolkit

sudo nvidia-ctk runtime configure --runtime=docker
sudo systemctl restart docker

echo "Enabling Docker services..."
sudo systemctl enable docker.service
sudo systemctl enable containerd.service

echo "Adding user to docker group..."
sudo usermod -aG docker $USER

sudo systemctl start docker

echo "Testing Docker installation..."
sudo docker run hello-world

echo ""
echo "Docker installation completed successfully!"
echo ""
echo "IMPORTANT: You need to log out and log back in (or restart) for docker group membership to take effect."
echo "After that, you should be able to run 'docker' commands without sudo."
echo ""
echo "To test GPU support (if you have NVIDIA GPU), run:"
echo "docker run --rm --gpus all nvidia/cuda:11.0-base nvidia-smi"
